<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org/">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            width: 50%;
            border-radius: 10px;
        }

        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<h1>공지사항 조회 페이지</h1>
<a href="/">index로 가기</a>
<a href="/logout">로그아웃</a>
<div id="noticeModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="noticeTitle"></h2>
        <p id="noticeContents"></p>
        <div class="modal-footer">
            <label>
                <input type="checkbox" id="dontShowToday"> 오늘 하루 보지 않기
            </label>
        </div>
    </div>
</div>
<script>
    let notices = [] //빈 배열 생성
    let currentIndex = 0 //공지사항 인덱스
    $(() => { //공지사항 데이터 가져오기
        $.ajax({
            url: "admin/showNotice",
            type: "get"
        }).done((data) => {
            console.log("data: ",data)
            notices = data //배열에 데이터 담기
            if (notices.length > 0){ //공지사항이 있으면 표시
                showNotice(currentIndex)
            }
        }).fail((err) => console.log("err: ",err))

        //닫기 버튼 클릭
        $('.close').click(() => {
            $('#noticeModal').fadeOut(() => {
                currentIndex++ //공지사항 인덱스 증가(다음 공지)
                if (currentIndex < notices.length){
                    showNotice(currentIndex) //공지사항 인덱스가 공지 갯수보다 적으면 다음 공지 표시
                }
            })
        })

        //오늘 하루 표시 안함 체크
        $('#dontShowToday').change(() => {
            if ($('#dontShowToday').is(':checked')){ //체크시 현재 공지에 쿠키 설정
                setCookie('hideNotice_' + currentIndex, 'true', 1)
                $('#noticeModal').fadeOut(() => {
                    currentIndex++ //다음 공지 표시
                    if (currentIndex < notices.length){
                        showNotice(currentIndex)
                    }
                })
            }
        })
    }) //ready end
    //공지사항 표시 함수
    function showNotice(index){
        if (getCookie('hideNotice_' + index) !== 'true'){ //'오늘 하루 표시 안함' 체크 안했을 때
            $('#noticeTitle').text(notices[index].notice_title)
            $('#noticeContents').text(notices[index].notice_contents)
            $('#noticeModal').fadeIn()
        }else { //체크 했을 때
            currentIndex++ //다음 공지 표시
            if (currentIndex < notices.length){
                showNotice(currentIndex)
            }
        }
    }

    //쿠키 설정 함수
    function setCookie(name, value){
        const now = new Date() //현재 날짜
        //현재 날짜의 년,월,일 구하고 일에 +1을 하고 시,분,초를 0,0,0으로 설정(다음 날 자정)
        const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0)
        // name=value; expires=다음날자정;(쿠키 만료기간) path=/;(경로(모든 페이지에서 쿠키에 접근 가능))
        document.cookie = name + '=' + value + '; expires=' + midnight.toUTCString() + '; path=/;'
    }
    //쿠키 가져오기 함수
    function getCookie(name){
        //쿠키 이름과 일치하는 부분을 찾는 정규식
        //matches = ["(^| )", name, "=([^;]+)"]
        const matches = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"))
        //일치하면 쿠키 이름(matches 배열의 두번째) 반환, 아니면 null 반환
        return matches ? matches[2] : null
    }
    console.log('cookie: ',document.cookie)
</script>
</body>
</html>